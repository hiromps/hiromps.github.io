<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALORANT Tracker Overlay</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Google AdSense script -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6090439809602995"
     crossorigin="anonymous"></script>
 <style>
        /* åŸºæœ¬çš„ãªãƒ˜ãƒƒãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .app-header {
            padding: 1rem;
            background-color: rgba(15, 25, 35, 0.95);
            border-bottom: 2px solid #ff4655;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            width: 100%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .nav-buttons {
            display: flex;
            gap: 1rem;
        }
        .app-header button,
        .app-header a.header-button {
            background-color: #ff4655;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            margin: 0 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-decoration: none; /* ä¸‹ç·šã‚’æ¶ˆã™ */
            display: inline-block; /* ãƒœã‚¿ãƒ³ã‚‰ã—ãè¦‹ã›ã‚‹ãŸã‚ */
            box-shadow: 0 2px 8px rgba(255, 70, 85, 0.3);
        }
        .app-header button:hover,
        .app-header a.header-button:hover {
            background-color: #e0303f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 70, 85, 0.4);
        }
        .app-header button.active,
        .app-header a.header-button.active {
            background-color: #22c55e; /* ç·‘ãªã©ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’ç¤ºã™ */
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
            text-decoration: none; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã‚‚ä¸‹ç·šã‚’æ¶ˆã™ */
        }
        @media screen and (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 0 10px;
                align-items: center;
            }
            .nav-buttons {
                flex-direction: row;
                width: 100%;
                gap: 0.3rem;
                justify-content: center;
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            .nav-buttons .header-button {
                width: auto;
                text-align: center;
                margin: 0;
                padding: 0.4rem 0.7rem;
                font-size: 0.85rem;
                min-width: 80px;
                white-space: nowrap;
            }
            .author-section {
                margin-top: 10px;
            }
        }
        .mode-container {
            /* display: none; */ /* åˆæœŸçŠ¶æ…‹ã¯JSã§åˆ¶å¾¡ */
        }
        .hidden {
            display: none !important;
        }
        #showOverlayModeLink {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #showTrackerModeLink {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <div class="nav-buttons">
                <a href="/" id="showOverlayModeLink" class="header-button active">OBSã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</a>
                <a href="./valorant-stats-tracker/" id="showTrackerModeLink" class="header-button">æˆ¦ç¸¾ãƒˆãƒ©ãƒƒã‚«ãƒ¼</a>
            </div>
            <div class="author-section">
                <p class="author-text">Project by ã«ã©å¯</p>
                <img src="assets/images/nidone.png" alt="è£½ä½œè€…ã‚¢ãƒã‚¿ãƒ¼" class="author-avatar">
            </div>
        </div>
    </header>
    <div class="background"></div>

    <!-- Google AdSenseåºƒå‘Šãƒ¦ãƒ‹ãƒƒãƒˆ -->
    <div class="ad-container">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6090439809602995"
             data-ad-slot="1000000000000000"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="main-content-container">
        <div id="inputSection" class="input-section">
            <h2>VALORANT ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±</h2>
            <div class="input-form">
                <input type="text" id="playerName" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å" required>
                <input type="text" id="playerTag" placeholder="ã‚¿ã‚°" required>
                <button onclick="generateURL()">URLã‚’ç”Ÿæˆ</button>
            </div>
            <div class="url-output">
                <input type="text" id="generatedURL" readonly>
                <button onclick="copyURL()">ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>

        <div class="right-column">
            <div class="overlay">
                <div class="rank-section">
                    <img src="assets/images/ranks/ãƒ©ãƒ³ã‚¯ãªã—.png" alt="Rank Icon" class="rank-icon" id="rankIcon">
                    <div class="rank-details">
                        <div class="rank-name-line">
                            <span class="rank-name" id="rankText">ãƒ©ãƒ³ã‚¯ãªã—</span> <span class="rr" id="rrText">0RR</span>
                        </div>
                        <!-- <span class="win-loss" id="winLossText">0 Win / 0 Loss</span> -->
                    </div>
                </div>
                <div class="last-match-section" id="lastMatchSection">
                    <div class="mmr-gauge-fill"></div>
                    <span class="last-match-text" id="lastMatchText">å‰å›ã®ãƒãƒƒãƒ +0pts</span>
                </div>
                <!-- OBSç”¨ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
                <div id="obsDebugInfo" style="display: none; font-size: 12px; color: #888; margin-top: 10px;">
                    <div>è‡ªå‹•æ›´æ–°: <span id="autoUpdateStatus">ç„¡åŠ¹</span></div>
                    <div>æœ€çµ‚æ›´æ–°: <span id="lastUpdateTime">-</span></div>
                    <button onclick="manualUpdate()" style="margin-top: 5px; padding: 2px 8px; font-size: 10px;">æ‰‹å‹•æ›´æ–°</button>
                </div>
            </div>
            
            <!-- ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ -->
            <div class="customize-button-container">
                <button id="customizeButton">ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</button>
            </div>
        </div>
    </div>

    <!-- OBSãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="tutorial-section">
        <button class="tutorial-toggle" onclick="toggleTutorial()">
            ğŸ“º OBSè¨­å®šã‚¬ã‚¤ãƒ‰ <span id="tutorialArrow" class="rotated">â–¼</span>
        </button>
        <div class="tutorial-content expanded" id="tutorialContent">
            <div class="tutorial-step">
                <h4>ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ— 1: URLã‚’ç”Ÿæˆ</h4>
                <p>ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã€ã€ŒURLã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div class="tutorial-step">
                <h4>ğŸ–¥ï¸ ã‚¹ãƒ†ãƒƒãƒ— 2: OBSã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ </h4>
                <ol>
                    <li>OBS Studioã‚’é–‹ã</li>
                    <li>ã€Œã‚½ãƒ¼ã‚¹ã€ã®ã€Œ+ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                    <li>ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã€ã‚’é¸æŠ</li>
                    <li>ã€Œæ–°è¦ä½œæˆã€ã‚’é¸æŠã—ã¦OKã‚’æŠ¼ã™</li>
                </ol>
            </div>
            <div class="tutorial-step">
                <h4>âš™ï¸ ã‚¹ãƒ†ãƒƒãƒ— 3: ãƒ–ãƒ©ã‚¦ã‚¶ã‚½ãƒ¼ã‚¹ã®è¨­å®š</h4>
                <ul>
                    <li><strong>URL:</strong> ç”Ÿæˆã•ã‚ŒãŸURLã‚’ã‚³ãƒ”ãƒ¼&ãƒšãƒ¼ã‚¹ãƒˆ</li>
                    <li><strong>å¹…:</strong> 450</li>
                    <li><strong>é«˜ã•:</strong> 200</li>
                    <li><strong>ã‚«ã‚¹ã‚¿ãƒ CSS:</strong> ãã®ã¾ã¾</li>
                </ul>
            </div>
            <div class="tutorial-step">
                <h4>âœ¨ ã‚¹ãƒ†ãƒƒãƒ— 4: ä½ç½®ã¨ã‚µã‚¤ã‚ºã®èª¿æ•´</h4>
                <p>OBSã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å¥½ããªä½ç½®ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½®ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            <div class="tutorial-note">
                <h4>ğŸ“ æ³¨æ„äº‹é …</h4>
                <ul>
                    <li>ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¯30ç§’é–“éš”ã§è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™</li>
                    <li>ãƒ©ãƒ³ã‚¯æƒ…å ±ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯URLã‚’ç”Ÿæˆã—ç›´ã—ã¦ãã ã•ã„</li>
                    <li>APIã®åˆ¶é™ã«ã‚ˆã‚Šã€ä¸€æ™‚çš„ã«ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="colorPickerModal" class="color-picker-modal">
        <div class="color-picker-content">
            <h3>ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h3>
            <div class="color-picker-section">
                <label for="rankBgColorPicker">ãƒ©ãƒ³ã‚¯èƒŒæ™¯è‰²:</label>
                <input type="color" id="rankBgColorPicker" value="#3a444e">
                <input type="range" id="rankBgOpacitySlider" min="0" max="100" value="100">
                <span id="rankBgOpacityValue">100%</span>
            </div>
            <div class="color-picker-section">
                <label for="lastMatchBgColorPicker">å‰å›ã®ãƒãƒƒãƒèƒŒæ™¯è‰²:</label>
                <input type="color" id="lastMatchBgColorPicker" value="#F44336">
                <input type="range" id="lastMatchBgOpacitySlider" min="0" max="100" value="100">
                <span id="lastMatchBgOpacityValue">100%</span>
            </div>
            <div class="color-picker-section">
                <label for="textColorPicker">æ–‡å­—è‰²:</label>
                <input type="color" id="textColorPicker" value="#ffffff">
            </div>
            <div class="color-picker-section">
                <label for="rrColorPicker">RRãƒ†ã‚­ã‚¹ãƒˆè‰²:</label>
                <input type="color" id="rrColorPicker" value="#ff4655">
            </div>
            <div class="color-picker-section">
                <label for="borderColorPicker">å¢ƒç•Œç·šè‰²:</label>
                <input type="color" id="borderColorPicker" value="#ff4655">
            </div>
            <div class="color-picker-buttons">
                <button onclick="applyCustomColors()">é©ç”¨</button>
                <button onclick="closeColorPicker()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="resetCustomColors()">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã¨æ›´æ–°é–“éš”ã‚’ç®¡ç†
        let currentPlayerName = null;
        let currentPlayerTag = null;
        let updateInterval = null;
        let isAutoUpdateEnabled = false;

        // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º/éè¡¨ç¤º
        function showColorPicker() {
            const modal = document.getElementById('colorPickerModal');
            modal.style.display = 'flex';
        }

        function closeColorPicker() {
            const modal = document.getElementById('colorPickerModal');
            modal.style.display = 'none';
        }

        // è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ï¼ˆæ”¹å–„ç‰ˆï¼‰
        function startAutoUpdate(intervalSeconds = 60) {
            if (isAutoUpdateEnabled || !currentPlayerName || !currentPlayerTag) {
                return;
            }

            isAutoUpdateEnabled = true;
            console.log(`è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆ${intervalSeconds}ç§’é–“éš”ï¼‰`);

            // å®šæœŸçš„ã«ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’æ›´æ–°
            updateInterval = setInterval(() => {
                if (currentPlayerName && currentPlayerTag) {
                    console.log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è‡ªå‹•æ›´æ–°ä¸­...');
                    updatePlayerInfo(currentPlayerName, currentPlayerTag).catch(error => {
                        console.error('è‡ªå‹•æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚è‡ªå‹•æ›´æ–°ã¯ç¶™ç¶š
                    });
                }
            }, intervalSeconds * 1000);
        }

        function stopAutoUpdate() {
            if (!isAutoUpdateEnabled) {
                return;
            }

            isAutoUpdateEnabled = false;
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
                console.log('è‡ªå‹•æ›´æ–°ã‚’åœæ­¢ã—ã¾ã—ãŸ');
            }
        }

        // OBSå°‚ç”¨ã®è‡ªå‹•æ›´æ–°æ©Ÿèƒ½ï¼ˆã‚ˆã‚Šå …ç‰¢ï¼‰
        function startOBSAutoUpdate(intervalSeconds = 60) {
            // æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯åœæ­¢ã—ã¦ã‹ã‚‰å†é–‹å§‹
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            isAutoUpdateEnabled = true;
            console.log(`OBSå°‚ç”¨è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã—ãŸï¼ˆ${intervalSeconds}ç§’é–“éš”ï¼‰`);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            updateAutoUpdateStatus();

            // å³åº§ã«ä¸€å›å®Ÿè¡Œã—ã¦ã‹ã‚‰å®šæœŸå®Ÿè¡Œã‚’é–‹å§‹
            if (currentPlayerName && currentPlayerTag) {
                updatePlayerInfo(currentPlayerName, currentPlayerTag).catch(error => {
                    console.error('åˆå›æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                });
            }

            // å®šæœŸå®Ÿè¡Œ
            updateInterval = setInterval(() => {
                if (currentPlayerName && currentPlayerTag) {
                    console.log(`[${new Date().toLocaleTimeString()}] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’è‡ªå‹•æ›´æ–°ä¸­...`);
                    updatePlayerInfo(currentPlayerName, currentPlayerTag).catch(error => {
                        console.error('è‡ªå‹•æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚è‡ªå‹•æ›´æ–°ã¯ç¶™ç¶š
                    });
                } else {
                    console.warn('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è‡ªå‹•æ›´æ–°ã‚’åœæ­¢ã—ã¾ã™ã€‚');
                    stopAutoUpdate();
                }
            }, intervalSeconds * 1000);
        }

        // è‡ªå‹•æ›´æ–°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç”»é¢ã«åæ˜ 
        function updateAutoUpdateStatus() {
            const statusElement = document.getElementById('autoUpdateStatus');
            const timeElement = document.getElementById('lastUpdateTime');
            
            if (statusElement) {
                statusElement.textContent = isAutoUpdateEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
                statusElement.style.color = isAutoUpdateEnabled ? '#4CAF50' : '#f44336';
            }
            
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleTimeString();
            }
        }

        // ãƒšãƒ¼ã‚¸éè¡¨ç¤º/è¡¨ç¤ºæ™‚ã®è‡ªå‹•æ›´æ–°åˆ¶å¾¡ï¼ˆOBSç”¨ã«èª¿æ•´ï¼‰
        document.addEventListener('visibilitychange', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const isOBS = urlParams.has('obs');
            
            // OBSãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å¯è¦–æ€§ã«é–¢ä¿‚ãªãè‡ªå‹•æ›´æ–°ã‚’ç¶™ç¶š
            if (isOBS) {
                console.log(`å¯è¦–æ€§å¤‰æ›´: ${document.hidden ? 'éè¡¨ç¤º' : 'è¡¨ç¤º'} - OBSãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚è‡ªå‹•æ›´æ–°ç¶™ç¶š`);
                return;
            }
            
            if (!currentPlayerName || !currentPlayerTag) {
                return;
            }

            if (document.hidden) {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã£ãŸã‚‰æ›´æ–°ã‚’ä¸€æ™‚åœæ­¢
                if (isAutoUpdateEnabled) {
                    stopAutoUpdate();
                    console.log('ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã£ãŸãŸã‚è‡ªå‹•æ›´æ–°ã‚’ä¸€æ™‚åœæ­¢');
                }
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰æ›´æ–°ã‚’å†é–‹
                if (!isAutoUpdateEnabled) {
                    const updateFreq = parseInt(urlParams.get('updateInterval')) || 60;
                    startAutoUpdate(updateFreq);
                    console.log('ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸãŸã‚è‡ªå‹•æ›´æ–°ã‚’å†é–‹');
                }
            }
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            stopAutoUpdate();
        });

        // èƒŒæ™¯è‰²ã®é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ›´æ–°
        document.getElementById('rankBgOpacitySlider').addEventListener('input', function(e) {
            document.getElementById('rankBgOpacityValue').textContent = e.target.value + '%';
        });

        // å‰å›ã®ãƒãƒƒãƒèƒŒæ™¯è‰²ã®é€æ˜åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ›´æ–°
        document.getElementById('lastMatchBgOpacitySlider').addEventListener('input', function(e) {
            document.getElementById('lastMatchBgOpacityValue').textContent = e.target.value + '%';
        });

        // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ã®é©ç”¨
        function applyCustomColors() {
            const rankBgColor = document.getElementById('rankBgColorPicker').value;
            const rankBgOpacity = document.getElementById('rankBgOpacitySlider').value;
            const lastMatchBgColor = document.getElementById('lastMatchBgColorPicker').value;
            const lastMatchBgOpacity = document.getElementById('lastMatchBgOpacitySlider').value;
            const textColor = document.getElementById('textColorPicker').value;
            const rrColor = document.getElementById('rrColorPicker').value;
            const borderColor = document.getElementById('borderColorPicker').value;

            // ãƒ©ãƒ³ã‚¯èƒŒæ™¯è‰²ã‚’rgbaå½¢å¼ã«å¤‰æ›
            const rankR = parseInt(rankBgColor.slice(1, 3), 16);
            const rankG = parseInt(rankBgColor.slice(3, 5), 16);
            const rankB = parseInt(rankBgColor.slice(5, 7), 16);
            const rgbaRankBgColor = `rgba(${rankR}, ${rankG}, ${rankB}, ${rankBgOpacity / 100})`;

            // å‰å›ã®ãƒãƒƒãƒèƒŒæ™¯è‰²ã‚’rgbaå½¢å¼ã«å¤‰æ›
            const lastMatchR = parseInt(lastMatchBgColor.slice(1, 3), 16);
            const lastMatchG = parseInt(lastMatchBgColor.slice(3, 5), 16);
            const lastMatchB = parseInt(lastMatchBgColor.slice(5, 7), 16);
            const rgbaLastMatchBgColor = `rgba(${lastMatchR}, ${lastMatchG}, ${lastMatchB}, ${lastMatchBgOpacity / 100})`;

            // CSSå¤‰æ•°ã‚’æ›´æ–°
            document.documentElement.style.setProperty('--rank-bg-color', rgbaRankBgColor);
            document.documentElement.style.setProperty('--last-match-bg-color', rgbaLastMatchBgColor);
            document.documentElement.style.setProperty('--text-color', textColor);
            document.documentElement.style.setProperty('--rr-color', rrColor);
            document.documentElement.style.setProperty('--border-color', borderColor);

            // è¨­å®šã‚’ä¿å­˜
            localStorage.setItem('customRankBgColor', rankBgColor);
            localStorage.setItem('customRankBgOpacity', rankBgOpacity);
            localStorage.setItem('customLastMatchBgColor', lastMatchBgColor);
            localStorage.setItem('customLastMatchBgOpacity', lastMatchBgOpacity);
            localStorage.setItem('customTextColor', textColor);
            localStorage.setItem('customRrColor', rrColor);
            localStorage.setItem('customBorderColor', borderColor);

            closeColorPicker();
        }

        // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã‚€
        function loadSavedSettings() {
            const savedRankBgColor = localStorage.getItem('customRankBgColor');
            const savedRankBgOpacity = localStorage.getItem('customRankBgOpacity');
            const savedLastMatchBgColor = localStorage.getItem('customLastMatchBgColor');
            const savedLastMatchBgOpacity = localStorage.getItem('customLastMatchBgOpacity');
            const savedTextColor = localStorage.getItem('customTextColor');
            const savedRrColor = localStorage.getItem('customRrColor');
            const savedBorderColor = localStorage.getItem('customBorderColor');

            if (savedRankBgColor && savedRankBgOpacity && savedTextColor) {
                // ãƒ©ãƒ³ã‚¯èƒŒæ™¯è‰²ã®è¨­å®š
                const rankR = parseInt(savedRankBgColor.slice(1, 3), 16);
                const rankG = parseInt(savedRankBgColor.slice(3, 5), 16);
                const rankB = parseInt(savedRankBgColor.slice(5, 7), 16);
                const rgbaRankBgColor = `rgba(${rankR}, ${rankG}, ${rankB}, ${savedRankBgOpacity / 100})`;

                // å‰å›ã®ãƒãƒƒãƒèƒŒæ™¯è‰²ã®è¨­å®š
                if (savedLastMatchBgColor && savedLastMatchBgOpacity) {
                    const lastMatchR = parseInt(savedLastMatchBgColor.slice(1, 3), 16);
                    const lastMatchG = parseInt(savedLastMatchBgColor.slice(3, 5), 16);
                    const lastMatchB = parseInt(savedLastMatchBgColor.slice(5, 7), 16);
                    const rgbaLastMatchBgColor = `rgba(${lastMatchR}, ${lastMatchG}, ${lastMatchB}, ${savedLastMatchBgOpacity / 100})`;
                    document.documentElement.style.setProperty('--last-match-bg-color', rgbaLastMatchBgColor);
                }

                document.documentElement.style.setProperty('--rank-bg-color', rgbaRankBgColor);
                document.documentElement.style.setProperty('--text-color', savedTextColor);
                if (savedRrColor) {
                    document.documentElement.style.setProperty('--rr-color', savedRrColor);
                }
                if (savedBorderColor) {
                    document.documentElement.style.setProperty('--border-color', savedBorderColor);
                }

                // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®å€¤ã‚’æ›´æ–°
                document.getElementById('rankBgColorPicker').value = savedRankBgColor;
                document.getElementById('rankBgOpacitySlider').value = savedRankBgOpacity;
                document.getElementById('rankBgOpacityValue').textContent = savedRankBgOpacity + '%';
                if (savedLastMatchBgColor && savedLastMatchBgOpacity) {
                    document.getElementById('lastMatchBgColorPicker').value = savedLastMatchBgColor;
                    document.getElementById('lastMatchBgOpacitySlider').value = savedLastMatchBgOpacity;
                    document.getElementById('lastMatchBgOpacityValue').textContent = savedLastMatchBgOpacity + '%';
                }
                document.getElementById('textColorPicker').value = savedTextColor;
                if (savedRrColor) {
                    document.getElementById('rrColorPicker').value = savedRrColor;
                }
                if (savedBorderColor) {
                    document.getElementById('borderColorPicker').value = savedBorderColor;
                }
            }
        }

        // è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        function resetCustomColors() {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’å®šç¾©
            const defaultRankBgColor = '#3a444e'; // VALORANTé¢¨ã®ã‚°ãƒ¬ãƒ¼
            const defaultRankBgOpacity = '100';
            const defaultLastMatchBgColor = '#F44336'; // ãƒ©ã‚¹ãƒˆãƒãƒƒãƒã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯è‰²
            const defaultLastMatchBgOpacity = '100';
            const defaultTextColor = '#ffffff'; // çœŸã£ç™½
            const defaultRrColor = '#ff4655'; // VALORANTé¢¨ã®ãƒ¬ãƒƒãƒ‰
            const defaultBorderColor = '#ff4655'; // VALORANTé¢¨ã®ãƒ¬ãƒƒãƒ‰

            // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®å€¤ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
            document.getElementById('rankBgColorPicker').value = defaultRankBgColor;
            document.getElementById('rankBgOpacitySlider').value = defaultRankBgOpacity;
            document.getElementById('rankBgOpacityValue').textContent = defaultRankBgOpacity + '%';
            document.getElementById('lastMatchBgColorPicker').value = defaultLastMatchBgColor;
            document.getElementById('lastMatchBgOpacitySlider').value = defaultLastMatchBgOpacity;
            document.getElementById('lastMatchBgOpacityValue').textContent = defaultLastMatchBgOpacity + '%';
            document.getElementById('textColorPicker').value = defaultTextColor;
            document.getElementById('rrColorPicker').value = defaultRrColor;
            document.getElementById('borderColorPicker').value = defaultBorderColor;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
            applyCustomColors();

            // localStorageã‹ã‚‰è¨­å®šã‚’å‰Šé™¤
            localStorage.removeItem('customRankBgColor');
            localStorage.removeItem('customRankBgOpacity');
            localStorage.removeItem('customLastMatchBgColor');
            localStorage.removeItem('customLastMatchBgOpacity');
            localStorage.removeItem('customTextColor');
            localStorage.removeItem('customRrColor');
            localStorage.removeItem('customBorderColor');
        }

        // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            const customizeButton = document.getElementById('customizeButton');
            if (customizeButton) {
                customizeButton.addEventListener('click', showColorPicker);
            }

            // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã‚€
            loadSavedSettings();
        });

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const name = urlParams.get('name');
            const tag = urlParams.get('tag');
            const isOBS = urlParams.has('obs');
            const updateFreq = parseInt(urlParams.get('updateInterval')) || 60; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60ç§’

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            currentPlayerName = name;
            currentPlayerTag = tag;

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è‰²è¨­å®šã‚’èª­ã¿è¾¼ã‚“ã§é©ç”¨
            const paramRankBgColor = urlParams.get('rankBgColor');
            const paramRankBgOpacity = urlParams.get('rankBgOpacity');
            const paramLastMatchBgColor = urlParams.get('lastMatchBgColor');
            const paramLastMatchBgOpacity = urlParams.get('lastMatchBgOpacity');
            const paramTextColor = urlParams.get('textColor');
            const paramRrColor = urlParams.get('rrColor');
            const paramBorderColor = urlParams.get('borderColor');

            if (paramRankBgColor && paramRankBgOpacity && paramTextColor) {
                // ãƒ©ãƒ³ã‚¯èƒŒæ™¯è‰²ã®è¨­å®š
                const rankR = parseInt(paramRankBgColor.slice(1, 3), 16);
                const rankG = parseInt(paramRankBgColor.slice(3, 5), 16);
                const rankB = parseInt(paramRankBgColor.slice(5, 7), 16);
                const rgbaRankBgColor = `rgba(${rankR}, ${rankG}, ${rankB}, ${paramRankBgOpacity / 100})`;

                // å‰å›ã®ãƒãƒƒãƒèƒŒæ™¯è‰²ã®è¨­å®š
                if (paramLastMatchBgColor && paramLastMatchBgOpacity) {
                    const lastMatchR = parseInt(paramLastMatchBgColor.slice(1, 3), 16);
                    const lastMatchG = parseInt(paramLastMatchBgColor.slice(3, 5), 16);
                    const lastMatchB = parseInt(paramLastMatchBgColor.slice(5, 7), 16);
                    const rgbaLastMatchBgColor = `rgba(${lastMatchR}, ${lastMatchG}, ${lastMatchB}, ${paramLastMatchBgOpacity / 100})`;
                    document.documentElement.style.setProperty('--last-match-bg-color', rgbaLastMatchBgColor);
                }

                document.documentElement.style.setProperty('--rank-bg-color', rgbaRankBgColor);
                document.documentElement.style.setProperty('--text-color', paramTextColor);

                if (paramRrColor) {
                    document.documentElement.style.setProperty('--rr-color', paramRrColor);
                }
                if (paramBorderColor) {
                    document.documentElement.style.setProperty('--border-color', paramBorderColor);
                }

                // localStorageã«ã‚‚ä¿å­˜ã—ã¦æ¬¡å›ä»¥é™ã‚‚åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
                localStorage.setItem('customRankBgColor', paramRankBgColor);
                localStorage.setItem('customRankBgOpacity', paramRankBgOpacity);
                if (paramLastMatchBgColor) localStorage.setItem('customLastMatchBgColor', paramLastMatchBgColor);
                if (paramLastMatchBgOpacity) localStorage.setItem('customLastMatchBgOpacity', paramLastMatchBgOpacity);
                localStorage.setItem('customTextColor', paramTextColor);
                if (paramRrColor) localStorage.setItem('customRrColor', paramRrColor);
                if (paramBorderColor) localStorage.setItem('customBorderColor', paramBorderColor);

                // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®å€¤ã‚’æ›´æ–°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸæ™‚ã«åæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
                // loadSavedSettings() ãŒ DOMContentLoaded ã§å‘¼ã°ã‚Œã‚‹ãŸã‚ä¸è¦ã ãŒå¿µã®ãŸã‚
                document.getElementById('rankBgColorPicker').value = paramRankBgColor;
                document.getElementById('rankBgOpacitySlider').value = paramRankBgOpacity;
                document.getElementById('rankBgOpacityValue').textContent = paramRankBgOpacity + '%';
                if (paramLastMatchBgColor && paramLastMatchBgOpacity) {
                    document.getElementById('lastMatchBgColorPicker').value = paramLastMatchBgColor;
                    document.getElementById('lastMatchBgOpacitySlider').value = paramLastMatchBgOpacity;
                    document.getElementById('lastMatchBgOpacityValue').textContent = paramLastMatchBgOpacity + '%';
                }
                document.getElementById('textColorPicker').value = paramTextColor;
                if (paramRrColor) document.getElementById('rrColorPicker').value = paramRrColor;
                if (paramBorderColor) document.getElementById('borderColorPicker').value = paramBorderColor;

            } else {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è‰²è¨­å®šãŒãªã„å ´åˆã¯localStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
                loadSavedSettings();
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
            window.onclick = function(event) {
                const modal = document.getElementById('colorPickerModal');
                if (event.target == modal) {
                    closeColorPicker();
                }
            }

            if (name && tag) {
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
                document.getElementById('inputSection').style.display = 'none';

                if (isOBS) {
                    // OBSãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
                    document.body.style.backgroundColor = 'transparent';
                    document.body.style.overflow = 'hidden';
                    // bodyã«OBSãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    document.body.classList.add('obs-mode');

                    // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    const headerElement = document.querySelector('.app-header');
                    if (headerElement) {
                        headerElement.style.display = 'none';
                    }

                    // èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã‚’éè¡¨ç¤º
                    const backgroundElement = document.querySelector('.background');
                    if (backgroundElement) {
                        backgroundElement.style.display = 'none';
                    }

                    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®OBSå‘ã‘ä½ç½®èª¿æ•´ï¼ˆä¸­å¤®ã«é…ç½®ï¼‰
                    const overlayElement = document.querySelector('.overlay');
                    if (overlayElement) {
                        overlayElement.style.position = 'absolute';
                        overlayElement.style.top = '50%';
                        overlayElement.style.left = '50%';
                        overlayElement.style.right = 'auto';
                        overlayElement.style.transform = 'translate(-50%, -50%)';
                    }

                    // è£½ä½œè€…ç´¹ä»‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                    const authorSectionElement = document.querySelector('.author-section');
                    if (authorSectionElement) {
                        authorSectionElement.style.display = 'none';
                    }
                    
                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã®è¡¨ç¤ºï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§debug=trueãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                    // const showDebug = urlParams.get('debug') === 'true';
                    // const debugElement = document.getElementById('obsDebugInfo');
                    // if (debugElement && showDebug) {
                    //     debugElement.style.display = 'block';
                    // }

                    // OBSãƒ¢ãƒ¼ãƒ‰ã§ã¯è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹
                    console.log(`OBSãƒ¢ãƒ¼ãƒ‰ã§è‡ªå‹•æ›´æ–°ã‚’æœ‰åŠ¹åŒ–ï¼ˆ${updateFreq}ç§’é–“éš”ï¼‰`);

                } else {
                    // é€šå¸¸ã®ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºã§ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½ç½®èª¿æ•´
                    document.querySelector('.overlay').style.top = '50%';
                    document.querySelector('.overlay').style.transform = 'translateY(-50%)';
                }

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’æ›´æ–°ï¼ˆåˆå›ï¼‰
                updatePlayerInfo(name, tag).then(() => {
                    // åˆå›æ›´æ–°å®Œäº†å¾Œã€OBSãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹
                    if (isOBS) {
                        startAutoUpdate(updateFreq);
                    }
                }).catch(error => {
                    console.error('åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚OBSãƒ¢ãƒ¼ãƒ‰ãªã‚‰è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹
                    if (isOBS) {
                        console.log('åˆå›å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€OBSãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚è‡ªå‹•æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã™');
                        startOBSAutoUpdate(updateFreq);
                    }
                });
                
                // OBSãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€åˆå›æ›´æ–°ã¨ä¸¦è¡Œã—ã¦è‡ªå‹•æ›´æ–°ã‚‚é–‹å§‹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                if (isOBS) {
                    // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰è‡ªå‹•æ›´æ–°ã‚’ç¢ºå®Ÿã«é–‹å§‹
                    setTimeout(() => {
                        if (!isAutoUpdateEnabled) {
                            console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: OBSè‡ªå‹•æ›´æ–°ã‚’å¼·åˆ¶é–‹å§‹');
                            startOBSAutoUpdate(updateFreq);
                        }
                    }, 2000);
                }
            } else if (isOBS) {
                // name, tag ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„ãŒ OBS ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                document.getElementById('inputSection').style.display = 'none';
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
                const headerElement = document.querySelector('.app-header');
                if (headerElement) {
                    headerElement.style.display = 'none';
                }
                
                // bodyã«OBSãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                document.body.classList.add('obs-mode');
                
                const backgroundElement = document.querySelector('.background');
                if (backgroundElement) {
                    backgroundElement.style.display = 'none';
                }
                // ãƒ‡ãƒ¼ã‚¿ãŒãªã„æ—¨ã‚’è¡¨ç¤º
                document.getElementById('rankText').textContent = 'æƒ…å ±ãªã—';
                document.getElementById('rrText').textContent = '';
                // document.getElementById('winLossText').textContent = '';
                document.getElementById('lastMatchSection').style.display = 'none';
            }
        }

        

        async function updatePlayerInfo(name, tag) {
            try {
                console.log(`[${new Date().toLocaleTimeString()}] ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’å–å¾—ä¸­: ${name}#${tag}`);
                
                // å …ç‰¢ãªAPIå‘¼ã³å‡ºã—ã‚’ä½¿ç”¨ï¼ˆæ”¹å–„ã•ã‚ŒãŸfetchPlayerStatsé–¢æ•°ã‚’ä½¿ç”¨ï¼‰
                const stats = await fetchPlayerStats(name, tag);

                console.log('Stats response:', stats);

                if (stats && stats.data) {
                    const playerData = stats.data; // stats.data ã®å†…å®¹ã‚’ç›´æ¥ä½¿ç”¨
                    console.log(`[${new Date().toLocaleTimeString()}] ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ`);

                    // ãƒ©ãƒ³ã‚¯æƒ…å ±ã‚’æ›´æ–°
                    const currentRank = playerData.currenttierpatched;
                    const rankingInTier = playerData.ranking_in_tier;
                    const mmrChange = playerData.mmr_change_to_last_game; // MMRå¤‰å‹•å€¤ã‚’å–å¾—

                    if (currentRank) {
                        // APIã‹ã‚‰å–å¾—ã—ãŸç”»åƒã®URLã‚’ä½¿ç”¨
                        if (playerData.images && playerData.images.large) {
                             document.getElementById('rankIcon').src = playerData.images.large;
                        } else {
                             // APIã«ç”»åƒURLãŒãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                             document.getElementById('rankIcon').src = getRankImageUrl(currentRank);
                        }

                        document.getElementById('rankText').textContent = currentRank;
                        document.getElementById('rrText').textContent = `${rankingInTier || 0}RR`;

                        // ç›´è¿‘ã®ãƒãƒƒãƒçµæœï¼ˆMMRå¤‰å‹•å€¤ï¼‰ã‚’æ›´æ–°
                        const lastMatchSection = document.getElementById('lastMatchSection');
                        const lastMatchText = document.getElementById('lastMatchText');
                        const mmrGaugeFill = lastMatchSection.querySelector('.mmr-gauge-fill');

                        // ç¾åœ¨ã®RRå€¤ã«åŸºã¥ã„ã¦ã‚²ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        if (rankingInTier !== undefined && rankingInTier !== null) {
                            // å‰å›ã®ãƒãƒƒãƒã®çµæœã®ã¿è¡¨ç¤º
                            if (mmrChange !== undefined) {
                                const sign = mmrChange >= 0 ? '+' : '';
                                lastMatchText.textContent = `å‰å›ã®ãƒãƒƒãƒ ${sign}${mmrChange}pts`;
                            } else {
                                lastMatchText.textContent = 'å‰å›ã®ãƒãƒƒãƒ';
                            }

                            // ã‚²ãƒ¼ã‚¸ã®å¹…ã‚’è¨ˆç®—ï¼ˆRRå€¤ / 100 * 100 = ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰
                            const gaugePercentage = Math.min(100, Math.max(0, rankingInTier)); // 0-100ã®ç¯„å›²ã«åˆ¶é™
                            
                            // å¸¸ã«ç·‘è‰²ã®ã‚²ãƒ¼ã‚¸ï¼ˆç¾åœ¨ã®ãƒ©ãƒ³ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¡¨ã™ãŸã‚ï¼‰
                            mmrGaugeFill.style.width = `${gaugePercentage}%`;
                            mmrGaugeFill.style.backgroundColor = '#4CAF50'; // ç·‘
                            mmrGaugeFill.style.left = '0';
                            mmrGaugeFill.style.right = 'auto';

                            lastMatchSection.style.display = 'flex'; // ã‚²ãƒ¼ã‚¸è¡¨ç¤ºã®ãŸã‚flexã«å¤‰æ›´
                        } else {
                            lastMatchSection.style.display = 'none';
                        }

                        console.log(`[${new Date().toLocaleTimeString()}] ãƒ©ãƒ³ã‚¯æƒ…å ±æ›´æ–°: ${currentRank} ${rankingInTier}RR`);

                    } else { // currentRank ãŒãªã„å ´åˆ (ä¾‹: ãƒ©ãƒ³ã‚¯ãªã—)
                        document.getElementById('rankIcon').src = 'assets/images/ranks/ãƒ©ãƒ³ã‚¯ãªã—.png';
                        document.getElementById('rankText').textContent = 'ãƒ©ãƒ³ã‚¯ãªã—';
                        document.getElementById('rrText').textContent = '';
                        document.getElementById('lastMatchSection').style.display = 'none';
                        console.log(`[${new Date().toLocaleTimeString()}] ãƒ©ãƒ³ã‚¯æƒ…å ±ãªã—`);
                    }

                } else { // stats ã¾ãŸã¯ stats.data ãŒå­˜åœ¨ã—ãªã„å ´åˆ
                    document.getElementById('rankIcon').src = 'assets/images/ranks/ãƒ©ãƒ³ã‚¯ãªã—.png';
                    document.getElementById('rankText').textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                    document.getElementById('rrText').textContent = '';
                    document.getElementById('lastMatchSection').style.display = 'none';
                    console.log(`[${new Date().toLocaleTimeString()}] APIå¿œç­”ã«ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“`);
                }
                
                // æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
                updateAutoUpdateStatus();

            } catch (error) {
                console.error(`[${new Date().toLocaleTimeString()}] Error updating player info:`, error);
                
                // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('rankIcon').src = 'assets/images/ranks/ãƒ©ãƒ³ã‚¯ãªã—.png';
                document.getElementById('rankText').textContent = 'ã‚¨ãƒ©ãƒ¼';
                document.getElementById('rrText').textContent = '';
                document.getElementById('lastMatchSection').style.display = 'none';
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æœ€çµ‚æ›´æ–°æ™‚åˆ»ã‚’æ›´æ–°
                updateAutoUpdateStatus();
            }
        }

        function generateURL() {
            const playerName = document.getElementById('playerName').value;
            const playerTag = document.getElementById('playerTag').value;
            
            if (!playerName || !playerTag) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¨ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const currentURL = window.location.href.split('?')[0];
            const urlParams = new URLSearchParams();
            urlParams.append('name', playerName);
            urlParams.append('tag', playerTag);
            urlParams.append('obs', ''); // OBSãƒ¢ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¿½åŠ 
            urlParams.append('updateInterval', '30'); // è‡ªå‹•æ›´æ–°é–“éš”ï¼ˆ30ç§’ï¼‰ã«çŸ­ç¸®

            // ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®šã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ 
            const savedRankBgColor = localStorage.getItem('customRankBgColor');
            const savedRankBgOpacity = localStorage.getItem('customRankBgOpacity');
            const savedLastMatchBgColor = localStorage.getItem('customLastMatchBgColor');
            const savedLastMatchBgOpacity = localStorage.getItem('customLastMatchBgOpacity');
            const savedTextColor = localStorage.getItem('customTextColor');
            const savedRrColor = localStorage.getItem('customRrColor');
            const savedBorderColor = localStorage.getItem('customBorderColor');

            if (savedRankBgColor) urlParams.append('rankBgColor', savedRankBgColor);
            if (savedRankBgOpacity) urlParams.append('rankBgOpacity', savedRankBgOpacity);
            if (savedLastMatchBgColor) urlParams.append('lastMatchBgColor', savedLastMatchBgColor);
            if (savedLastMatchBgOpacity) urlParams.append('lastMatchBgOpacity', savedLastMatchBgOpacity);
            if (savedTextColor) urlParams.append('textColor', savedTextColor);
            if (savedRrColor) urlParams.append('rrColor', savedRrColor);
            if (savedBorderColor) urlParams.append('borderColor', savedBorderColor);
            
            const newURL = `${currentURL}?${urlParams.toString()}`;
            document.getElementById('generatedURL').value = newURL;
        }

        function copyURL() {
            const urlInput = document.getElementById('generatedURL');
            urlInput.select();
            document.execCommand('copy');
            alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }

        function manualUpdate() {
            console.log('æ‰‹å‹•æ›´æ–°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
            updatePlayerInfo(currentPlayerName, currentPlayerTag).then(() => {
                console.log('æ‰‹å‹•æ›´æ–°ãŒæˆåŠŸã—ã¾ã—ãŸ');
            }).catch(error => {
                console.error('æ‰‹å‹•æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
            });
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®é–‹é–‰æ©Ÿèƒ½
        function toggleTutorial() {
            const content = document.getElementById('tutorialContent');
            const arrow = document.getElementById('tutorialArrow');
            
            if (content.classList.contains('expanded')) {
                // é–‰ã˜ã‚‹
                content.classList.remove('expanded');
                arrow.classList.remove('rotated');
            } else {
                // é–‹ã
                content.classList.add('expanded');
                arrow.classList.add('rotated');
            }
        }
    </script>
</body>
</html> 
